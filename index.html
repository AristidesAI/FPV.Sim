<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betaflight Actual Rates Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2196F3;
            --accent: #FFC107;
            --bg-light: #f5f5f5;
            --surface-light: #ffffff;
            --text-light: #333333;
            --bg-dark: #121212;
            --surface-dark: #1e1e1e;
            --text-dark: #e0e0e0;
            --border-radius: 12px;
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 340px;
            padding: 20px;
            background-color: var(--surface-light);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 20;
            overflow-y: auto;
            transition: background-color 0.3s;
        }

        body.dark-mode #sidebar { background-color: var(--surface-dark); }

        h2 { margin: 0; font-weight: 700; font-size: 1.5rem; }
        h3 { margin: 0 0 8px 0; font-size: 0.85rem; text-transform: uppercase; color: var(--primary); letter-spacing: 0.5px; }

        .control-group {
            background: rgba(0,0,0,0.04);
            padding: 12px;
            border-radius: var(--border-radius);
        }
        body.dark-mode .control-group { background: rgba(255,255,255,0.05); }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .input-row label { font-size: 0.8rem; flex: 1; }
        .input-row input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: transparent;
            color: inherit;
            text-align: right;
        }

        /* --- BUTTONS --- */
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            width: 100%;
            margin-bottom: 5px;
        }
        button:hover { filter: brightness(1.1); }
        
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-secondary { background-color: #607D8B; color: white; }
        .btn-accent { background-color: var(--accent); color: #333; }

        /* --- CANVAS --- */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background: radial-gradient(circle at center, #e0e0e0 0%, #bdbdbd 100%);
        }
        body.dark-mode #canvas-container {
            background: radial-gradient(circle at center, #2c2c2c 0%, #000000 100%);
        }

        /* --- MAPPING MODAL --- */
        #mapping-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--surface-light);
            padding: 25px;
            border-radius: 16px;
            width: 450px;
            max-width: 90%;
            color: var(--text-light);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        body.dark-mode .modal-content {
            background: var(--surface-dark);
            color: var(--text-dark);
        }
        
        .map-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        body.dark-mode .map-row { border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        .map-label { width: 60px; font-weight: bold; }
        .map-select { flex: 1; padding: 8px; border-radius: 6px; }
        .map-invert { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .axis-viz {
            width: 100px;
            height: 10px;
            background: #ddd;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        .axis-bar {
            position: absolute;
            top: 0; left: 50%;
            height: 100%;
            width: 0%; /* Dynamic */
            background: var(--primary);
            transition: width 0.05s, left 0.05s;
        }

        /* --- NOTIFICATIONS --- */
        #notification-area {
            position: absolute;
            top: 20px; right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200;
        }
        .toast {
            background-color: var(--surface-light);
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 5px solid var(--primary);
            animation: slideIn 0.3s ease-out;
        }
        body.dark-mode .toast { background-color: var(--surface-dark); color: var(--text-dark); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="sidebar">
        <div>
            <h2>Actual Rates</h2>
            <p style="font-size: 0.8rem; opacity: 0.7; margin-top:5px;">Betaflight Rate Simulator</p>
        </div>

        <button id="open-mapping" class="btn-accent">ðŸŽ® Configure Controller</button>

        <div class="control-group">
            <h3>Roll</h3>
            <div class="input-row"><label>Center Sens</label><input type="number" id="roll-center" value="70"></div>
            <div class="input-row"><label>Max Rate</label><input type="number" id="roll-max" value="670"></div>
            <div class="input-row"><label>Expo</label><input type="number" id="roll-expo" value="0.55" step="0.01"></div>
        </div>

        <div class="control-group">
            <h3>Pitch</h3>
            <div class="input-row"><label>Center Sens</label><input type="number" id="pitch-center" value="70"></div>
            <div class="input-row"><label>Max Rate</label><input type="number" id="pitch-max" value="670"></div>
            <div class="input-row"><label>Expo</label><input type="number" id="pitch-expo" value="0.55" step="0.01"></div>
        </div>

        <div class="control-group">
            <h3>Yaw</h3>
            <div class="input-row"><label>Center Sens</label><input type="number" id="yaw-center" value="70"></div>
            <div class="input-row"><label>Max Rate</label><input type="number" id="yaw-max" value="670"></div>
            <div class="input-row"><label>Expo</label><input type="number" id="yaw-expo" value="0.55" step="0.01"></div>
        </div>

        <div style="margin-top: auto;">
            <button id="reset-cam" class="btn-secondary">Reset View</button>
            <button id="theme-toggle" class="btn-primary">Toggle Dark Mode</button>
        </div>
    </div>

    <div id="canvas-container"></div>

    <div id="notification-area"></div>

    <div id="mapping-modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Controller Mapping</h2>
            <p style="font-size: 0.9rem; margin-bottom: 20px; opacity: 0.8;">
                Move your sticks to identify axes. Assign them to the correct functions.
            </p>

            <div id="mapping-rows"></div>

            <button id="close-mapping" class="btn-primary" style="margin-top: 20px;">Save & Close</button>
        </div>
    </div>

    <script>
        // --- 1. STATE & STORAGE ---
        // Default mapping (Generic Gamepad)
        let config = {
            mapping: {
                roll: { axis: 2, invert: false },
                pitch: { axis: 3, invert: false },
                yaw: { axis: 0, invert: true },    // Yaw usually needs invert in 3D space
                throttle: { axis: 1, invert: true } // Throttle -1 is usually UP on gamepads
            },
            rates: {
                // defaults handled in HTML values
            }
        };

        // Load from LocalStorage
        const savedConfig = localStorage.getItem('bf_rate_config');
        if (savedConfig) {
            try {
                const parsed = JSON.parse(savedConfig);
                if(parsed.mapping) config.mapping = parsed.mapping;
            } catch(e) { console.log('Config load error'); }
        }

        function saveConfig() {
            localStorage.setItem('bf_rate_config', JSON.stringify(config));
        }

        // --- 2. THEME & UI ---
        const body = document.body;
        const themeBtn = document.getElementById('theme-toggle');
        
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            body.classList.add('dark-mode');
        }
        themeBtn.addEventListener('click', () => body.classList.toggle('dark-mode'));

        function showNotification(msg) {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = msg;
            area.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(()=>toast.remove(),300);}, 3000);
        }

        // --- 3. THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
        
        // Initial Camera Position
        camera.position.set(0, 1, 3.5);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dl = new THREE.DirectionalLight(0xffffff, 0.8);
        dl.position.set(5, 10, 7);
        scene.add(dl);

        // Drone Group
        const droneGroup = new THREE.Group();
        
        // Visual Body
        const matBody = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.5 });
        const matArm = new THREE.MeshStandardMaterial({ color: 0x2196F3, roughness: 0.5 });
        const matProp = new THREE.MeshStandardMaterial({ color: 0xeeeeee, transparent: true, opacity: 0.4 });

        const bodyMesh = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.15, 0.3), matBody);
        droneGroup.add(bodyMesh);

        // Arms (X Shape)
        const arm1 = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.05, 1.8), matArm);
        arm1.rotation.y = Math.PI/4;
        const arm2 = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.05, 1.8), matArm);
        arm2.rotation.y = -Math.PI/4;
        droneGroup.add(arm1);
        droneGroup.add(arm2);

        // Props
        [
            {x:-0.6, z:0.6}, {x:0.6, z:-0.6}, 
            {x:0.6, z:0.6}, {x:-0.6, z:-0.6}
        ].forEach(pos => {
            const prop = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.02, 32), matProp);
            prop.position.set(pos.x, 0.08, pos.z);
            droneGroup.add(prop);
        });

        // Axis Helper (Red=X, Green=Y, Blue=Z)
        droneGroup.add(new THREE.AxesHelper(1));
        scene.add(droneGroup);

        // Ground Grid
        const grid = new THREE.GridHelper(30, 30, 0x888888, 0xcccccc);
        grid.position.y = -2;
        scene.add(grid);

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        document.getElementById('reset-cam').addEventListener('click', () => {
            droneGroup.rotation.set(0,0,0);
            droneGroup.position.set(0,0,0);
        });

        // --- 4. CONTROLLER MAPPING UI LOGIC ---
        const modal = document.getElementById('mapping-modal');
        const rowsContainer = document.getElementById('mapping-rows');
        const functions = ['Roll', 'Pitch', 'Yaw', 'Throttle'];
        
        let activeGamepadIndex = null;

        document.getElementById('open-mapping').addEventListener('click', () => {
            if (activeGamepadIndex === null) {
                showNotification("Connect controller first!");
                return;
            }
            renderMappingUI();
            modal.style.display = 'flex';
        });

        document.getElementById('close-mapping').addEventListener('click', () => {
            modal.style.display = 'none';
            saveConfig();
            showNotification("Mapping Saved");
        });

        function renderMappingUI() {
            rowsContainer.innerHTML = '';
            
            functions.forEach(func => {
                const key = func.toLowerCase();
                const setting = config.mapping[key];

                const row = document.createElement('div');
                row.className = 'map-row';

                // Label
                const label = document.createElement('div');
                label.className = 'map-label';
                label.innerText = func;
                
                // Select Axis
                const select = document.createElement('select');
                select.className = 'map-select';
                for(let i=0; i<8; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = `Axis ${i}`;
                    if(i === setting.axis) opt.selected = true;
                    select.appendChild(opt);
                }
                select.onchange = (e) => config.mapping[key].axis = parseInt(e.target.value);

                // Invert Checkbox
                const invertDiv = document.createElement('div');
                invertDiv.className = 'map-invert';
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.checked = setting.invert;
                chk.onchange = (e) => config.mapping[key].invert = e.target.checked;
                invertDiv.appendChild(chk);
                invertDiv.appendChild(document.createTextNode('Inv'));

                // Live Visualizer
                const viz = document.createElement('div');
                viz.className = 'axis-viz';
                const bar = document.createElement('div');
                bar.className = 'axis-bar';
                bar.id = `viz-${key}`; // ID for animation loop update
                viz.appendChild(bar);

                row.appendChild(label);
                row.appendChild(select);
                row.appendChild(invertDiv);
                row.appendChild(viz);
                rowsContainer.appendChild(row);
            });
        }

        // --- 5. ACTUAL RATES MATH ---
        function calculateActualRate(input, centerSens, maxRate, expo) {
            const deflection = Math.abs(input);
            if (deflection < 0.02) return 0; // deadband
            
            const s = centerSens;
            const m = maxRate;
            const e = expo;
            
            // Betaflight-ish curve approximation for visual smoothness
            const curve = Math.pow(deflection, 1 + (e * 3));
            const rateMag = s + (m - s) * curve;
            
            return (deflection * rateMag) * Math.sign(input);
        }

        // --- 6. MAIN LOOP ---
        window.addEventListener("gamepadconnected", (e) => {
            activeGamepadIndex = e.gamepad.index;
            showNotification(`Connected: ${e.gamepad.id}`);
        });
        window.addEventListener("gamepaddisconnected", () => {
            activeGamepadIndex = null;
            showNotification("Disconnected");
        });

        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            if (activeGamepadIndex !== null) {
                const gp = navigator.getGamepads()[activeGamepadIndex];
                if (gp) {
                    
                    // 1. READ RAW AXES BASED ON MAPPING
                    const getAxisVal = (name) => {
                        const map = config.mapping[name];
                        let val = gp.axes[map.axis] || 0;
                        if (map.invert) val *= -1;
                        return val;
                    };

                    const rawRoll = getAxisVal('roll');
                    const rawPitch = getAxisVal('pitch');
                    const rawYaw = getAxisVal('yaw');
                    const rawThr = getAxisVal('throttle');

                    // 2. UPDATE MAPPING MENU VISUALIZERS (If open)
                    if(modal.style.display === 'flex') {
                        const updateViz = (name, val) => {
                            const bar = document.getElementById(`viz-${name}`);
                            if(bar) {
                                // Map -1..1 to 0..100%
                                // Center (0) = 50%
                                const pct = (val + 1) * 50;
                                bar.style.left = val < 0 ? `${pct}%` : '50%';
                                bar.style.width = `${Math.abs(val) * 50}%`;
                            }
                        };
                        updateViz('roll', rawRoll);
                        updateViz('pitch', rawPitch);
                        updateViz('yaw', rawYaw);
                        updateViz('throttle', rawThr);
                    }

                    // 3. APPLY RATES
                    const rC = parseFloat(document.getElementById('roll-center').value);
                    const rM = parseFloat(document.getElementById('roll-max').value);
                    const rE = parseFloat(document.getElementById('roll-expo').value);

                    const pC = parseFloat(document.getElementById('pitch-center').value);
                    const pM = parseFloat(document.getElementById('pitch-max').value);
                    const pE = parseFloat(document.getElementById('pitch-expo').value);

                    const yC = parseFloat(document.getElementById('yaw-center').value);
                    const yM = parseFloat(document.getElementById('yaw-max').value);
                    const yE = parseFloat(document.getElementById('yaw-expo').value);

                    const rollRate = calculateActualRate(rawRoll, rC, rM, rE);
                    const pitchRate = calculateActualRate(rawPitch, pC, pM, pE);
                    const yawRate = calculateActualRate(rawYaw, yC, yM, yE);

                    // 4. APPLY ROTATION
                    // Pitch (X axis), Yaw (Y axis), Roll (Z axis)
                    droneGroup.rotateX(THREE.Math.degToRad(pitchRate * dt));
                    droneGroup.rotateY(THREE.Math.degToRad(yawRate * dt)); 
                    droneGroup.rotateZ(THREE.Math.degToRad(-rollRate * dt)); // Roll usually inverted visually

                    // 5. THROTTLE PHYSICS (Floating)
                    // Map throttle (-1 to 1) to Height (-1.5 to 1.5)
                    const targetY = rawThr * 2.0; 
                    // Smooth lerp
                    droneGroup.position.y += (targetY - droneGroup.position.y) * 5 * dt;
                }
            }

            renderer.render(scene, camera);
        }

        animate();

    </script>
</body>
</html>
